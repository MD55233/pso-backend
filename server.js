const express = require('express');
const multer = require('multer');
const path = require('path');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const cors = require('cors');
require('dotenv').config();
const nodemailer = require('nodemailer');
const jwt = require('jsonwebtoken');

const app = express();
const PORT = 8001;

// SMTP Configuration for Hostinger Webmail
const transporter = nodemailer.createTransport({
  host: "smtp.hostinger.com",
  port: 465,
  secure: true,
  auth: {
      user: 'process.env.SMTP_EMAIL',
      pass: 'process.env.SMTP_PASSWORD',
  },
 auth: {
    user: process.env.SMTP_EMAIL,
    pass: process.env.SMTP_PASSWORD,
},

});

// Generate Random Username and Password
const generateCredentials = () => {
  const username = `user${Math.floor(1000 + Math.random() * 9000)}`;
  const password = Math.random().toString(36).slice(-8);
  return { username, password };
};

// ------------||Serve static files from the 'uploads' directory||----------------------
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

console.log('Attempting to start server on port:', PORT);

// Connect to MongoDB
mongoose
  .connect(process.env.MONGO_URI)
  .then(() => console.log('MongoDB connected successfully'))
  .catch((err) => console.error('MongoDB connection error:', err));

// Your middleware and routes go here

app.listen(PORT, (err) => {
  if (err) {
    console.error('Error starting server:', err);
  } else {
    console.log(`Server is running on port ${PORT}`);
  }
});

// Close the Mongoose connection if the Node process ends
process.on('SIGINT', () => {
  mongoose.connection.close(() => {
    console.log('Mongoose connection disconnected through app termination');
    process.exit(0);
  });
});
app.use(bodyParser.json());
app.use(cors());

// User Model
const userSchema = new mongoose.Schema(
  {
    fullName: { type: String, required: true, trim: true },
    username: { type: String, required: true, unique: true, trim: true },
    password: { type: String, required: true },
    email: { type: String, required: true, unique: true, trim: true },
    phoneNumber: { type: String, required: true },
    accountType: { type: String, required: true,  default: 'Starter' }, // e.g., "Starter", "Pro", "Premium"
    balance: { type: Number, default: 0 },
    withdrawalBalance: { type: Number, default: 0 },
    dailyTaskLimit: { type: Number, required: true , default: 10 },
    lastCompletedDate: { type: Date, default: null },
    tasksCompletedToday: { type: Number, default: 0 },
    bonusBalance: { type: Number, default: 0 },
    referralDetails: {
      referralCode: { type: String, unique: true },
      referrer: { type: mongoose.Schema.Types.ObjectId, ref: 'User', default: null },
    },
    taskHistory: [
      {
        taskId: { type: mongoose.Schema.Types.ObjectId, ref: 'Task' },
        completedAt: { type: Date },
        reward: { type: Number },
      },
    ],
    transactionHistory: [
      {
        type: { type: String, required: true }, // "credit" or "debit"
        amount: { type: Number, required: true },
        description: { type: String, trim: true },
        createdAt: { type: Date, default: Date.now },
      },
    ],
    commissionPendingTasks: [
      {
        taskId: { type: mongoose.Schema.Types.ObjectId, ref: 'Task' },
        commissionAmount: { type: Number, required: true },
        releaseDate: { type: Date, required: true },
      },
    ],
    planActivationDate: { type: Date, default: null },
    profilePicture: { type: String, default: null },
    parent: { type: mongoose.Schema.Types.ObjectId, ref: 'User', default: null },
    pendingCommission: { type: Number, default: 0 },
  },
  { timestamps: true }
);

const User = mongoose.model('User', userSchema);  // Define User model

// Admin Schema
const adminSchema = new mongoose.Schema({
  fullName: { type: String, required: true, trim: true },
  username: { type: String, required: true, unique: true, trim: true },
  password: { type: String, required: true },
  totalProfit: { type: Number, default: 0 },
  monthlyProfit: { type: Number, default: 0 },
  transactions: [{
    amount: { type: Number, required: true },
    type: { type: String, required: true }, // e.g., "Withdrawal", "Deposit"
    date: { type: Date, default: Date.now }
  }]
}, { timestamps: true });

const Admin = mongoose.model('Admin', adminSchema);

app.post('/api/signup', async (req, res) => {
  const { fullName, email, phoneNumber, referrerPin } = req.body;

  try {
    // Check if email already exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ success: false, message: 'Email already exists. Please use a different email.' });
    }

    // Check if the referrerPin matches an existing username
    let referrer = null;
    if (referrerPin) {
      referrer = await User.findOne({ username: referrerPin });
      if (!referrer) {
        return res.status(400).json({ success: false, message: 'Invalid referral code (referrerPin). Please check and try again.' });
      }
    }

    const { username, password } = generateCredentials();

    const newUser = new User({
      fullName,
      username,
      email,
      phoneNumber,
      password,
      referralDetails: {
        referralCode: referrer ? referrer.username : null, // Set referralCode to referrer’s username
        referrer: referrer ? referrer._id : null, // Store referrer’s ObjectId for reference
      },
    });

    await newUser.save();

  
  
   // Send Email
    await transporter.sendMail({
      from: `LaikoStar.Team <${process.env.SMTP_EMAIL}>`,
      to: email,
      subject: 'Welcome to Our Platform!',
      html: `
        <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
          <h2 style="color: #4CAF50; text-align: center;">Welcome to Our Platform,</h2>
            <h2 style="color: #4CAF50; text-align: center;"> ${fullName}!</h2>
          <p>We are thrilled to have you on board. Your account has been successfully created, and here are your details:</p>
          <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f9f9f9;">
            <p><strong>Username:</strong> ${username}</p>
            <p><strong>Password:</strong> ${password}</p>
            <p><strong>Referral Code:</strong> ${referrer ? referrer.username : 'None'}</p>
          </div>
          <p>Please keep these details safe and secure. You can use them to log in to your account anytime.</p>
          <h3 style="color: #4CAF50;">Get Started</h3>
          <p>Click the button below to log in to your account:</p>
          <div style="text-align: center; margin: 20px 0;">
            <a href="https://account.laikostar.com/pages/login/login3" 
               style="text-decoration: none; padding: 10px 20px; color: white; background-color: #4CAF50; border-radius: 5px; font-weight: bold;">Log In to Your Account</a>
          </div>
          <p>If you have any questions, feel free to reach out to our support team.</p>
          <p>Thank you for choosing us!</p>
          <p style="margin-top: 20px;">Warm regards,<br><strong>The Team at Our Platform</strong></p>
          <p><img style="display: block; margin-left: auto; margin-right: auto" src="data:image/png;base64,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
        </div>
      `,
    });

    res.json({ success: true });
  } catch (err) {
    if (err.code === 11000) {
      // Duplicate key error (e.g., email or username already exists)
      return res.status(400).json({ success: false, message: 'Email or username already exists. Please use a different one.' });
    }
    console.error(err);
    res.status(500).json({ success: false, message: 'Server Error' });
  }
});
// Route to fetch all data of a user based on username
app.get('/api/user/:username', async (req, res) => {
  const { username } = req.params;

  try {
    // Find the user by username and populate related fields
    const user = await User.findOne({ username })
      .populate('taskHistory.taskId') // Populate task details
      .populate('commissionPendingTasks.taskId') // Populate commission pending tasks
      .exec();

    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }

    // Prepare the response with all relevant user data
    const userData = {
      _id: user._id,
      fullName: user.fullName,
      username: user.username,
      email: user.email,
      phoneNumber: user.phoneNumber,
      accountType: user.accountType,
      balance: user.balance,
      withdrawalBalance: user.withdrawalBalance,
      dailyTaskLimit: user.dailyTaskLimit,
      tasksCompletedToday: user.tasksCompletedToday,
      bonusBalance: user.bonusBalance,
      referralDetails: user.referralDetails,
      taskHistory: user.taskHistory,
      transactionHistory: user.transactionHistory,
      commissionPendingTasks: user.commissionPendingTasks,
      planActivationDate: user.planActivationDate,
      profilePicture: user.profilePicture,
      parent: user.parent,
      pendingCommission: user.pendingCommission,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
    };

    // Return the complete user data
    res.status(200).json({ user: userData });

  } catch (error) {
    console.error('Error fetching user data:', error);
    res.status(500).json({ error: 'Internal Server Error', details: error.message });
  }
});
// Configure Multer for file uploads
const fileStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, '../uploads/tasks');
  },
  filename: (req, file, cb) => {
    cb(null, `${Date.now()}-${file.originalname}`);
  },
});

const uploadFile = multer({ storage: fileStorage });

// Task Schema
const taskSchema = new mongoose.Schema(
  {
    name: { type: String, required: true },
    description: { type: String, required: true },
    reward: { type: Number, required: true },
    image: { type: String }, // URL to the task image
    completedCount: { type: Number, default: 0 }, 
    createdAt: { type: Date, default: Date.now },
  },
  { timestamps: true }
);

const TaskModel = mongoose.model('Task', taskSchema);
// TaskTransaction Schema with username
const taskTransactionSchema = new mongoose.Schema(
  {
    username: {
      type: String,
      required: true
    },
    taskId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Task',
      required: true
    },
    amount: {
      type: Number,
      required: true
    },
    status: {
      type: String,
      enum: ['pending', 'approved', 'rejected'],
      default: 'pending'
    },
    description: {
      type: String,
      required: true
    },
    createdAt: {
      type: Date,
      default: Date.now
    },
    transactionType: {
      type: String,
      enum: ['credit', 'debit'],
      required: true
    }
  },
  { timestamps: true }
);
const TaskTransaction = mongoose.model('TaskTransaction', taskTransactionSchema);
// Routes
// Fetch all tasks
app.get('/api/tasks', async (req, res) => {
  try {
    const tasks = await TaskModel.find();
    res.status(200).json({ tasks });
  } catch (error) {
    console.error('Error fetching tasks:', error);
    res.status(500).json({ error: 'Internal Server Error', details: error.message });
  }
});
app.post('/api/tasks/:taskId/complete', async (req, res) => {
  const { taskId } = req.params;
  const { username } = req.body;

  // Validate username
  if (!username || typeof username !== 'string') {
    return res.status(400).json({ error: 'Invalid username' });
  }

  try {
    // Find the user by username
    const user = await User.findOne({ username: username });
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }

    const today = new Date().toISOString().split('T')[0]; // Today's date in YYYY-MM-DD format
    const lastCompletedDate = user.lastCompletedDate
      ? user.lastCompletedDate.toISOString().split('T')[0]
      : null;

    // Reset daily tasks if it's a new day
    if (lastCompletedDate !== today) {
      user.tasksCompletedToday = 0;
      user.lastCompletedDate = new Date();
    }

    // Check if the user has exceeded their daily task limit
    if (user.tasksCompletedToday >= user.dailyTaskLimit) {
      return res.status(400).json({ error: 'Daily task limit reached. Please try again tomorrow.' });
    }

    // Find the task
    const task = await TaskModel.findById(taskId);
    if (!task) {
      return res.status(404).json({ error: 'Task not found' });
    }

    // Increment the user's task completion count for the day
    user.tasksCompletedToday += 1;

    // Update the user's pending commission
    user.pendingCommission += task.reward;

    // Increment the task completion count
    task.completedCount = (task.completedCount || 0) + 1;

    // Create a TaskTransaction record
    const transaction = new TaskTransaction({
      username: username,
      taskId: task._id,
      amount: task.reward,
      status: 'pending', // Transaction status is pending initially
      description: `Completed task: ${task.name}`,
      transactionType: 'credit', // Credit for task completion
    });

    // Save the TaskTransaction, task, and user
    await transaction.save();
    await task.save();
    await user.save();

    // Respond with success message
    res.status(200).json({
      message: 'Task completed successfully',
      tasksCompletedToday: user.tasksCompletedToday,
      balance: user.pendingCommission,
      task: {
        id: task._id,
        name: task.name,
        reward: task.reward,
      },
    });
  } catch (error) {
    console.error('Error completing task:', error);
    res.status(500).json({ error: 'Internal Server Error', details: error.message });
  }
});


// Create a new task with an image upload
app.post('/api/tasks', uploadFile.single('image'), async (req, res) => {
  const { name, description, reward } = req.body;
  const image = req.file ? req.file.path : null;

  try {
    const newTask = new TaskModel({ name, description, reward, image });
    await newTask.save();
    res.status(201).json({ message: 'Task created successfully', task: newTask });
  } catch (error) {
    console.error('Error creating task:', error);
    res.status(500).json({ error: 'Internal Server Error', details: error.message });
  }
});

// Fetch Task Transactions for a specific user
app.get('/api/task-transactions/:username', async (req, res) => {
  const { username } = req.params;

  try {
    // Find all task transactions for the given username
    const taskTransactions = await TaskTransaction.find({ username })
      .populate('taskId', 'name')  // Populate task name from Task model
      .sort({ createdAt: -1 }); // Sort by most recent transaction

    if (!taskTransactions) {
      return res.status(404).json({ message: 'No transactions found for this user.' });
    }

    res.status(200).json(taskTransactions);
  } catch (error) {
    console.error('Error fetching task transactions:', error);
    res.status(500).json({ message: 'Internal server error while fetching task transactions.' });
  }
});

// ]----------------------||Authentication Endpoint||--------------------------------[

app.post('/api/authenticate', async (req, res) => {
  const { usernameOrEmail, password } = req.body;

  try {
    const user = await User.findOne({
      $or: [{ username: usernameOrEmail }, { email: usernameOrEmail }],
      password: password
    });

    if (user) {
      res.json({ success: true, username: user.username });
    } else {
      res.json({ success: false });
    }
  } catch (error) {
    console.error('Error during authentication:', error);
    res.status(500).json({ success: false, error: 'Server error' });
  }
});
//------------------------||Training Bonus Approval Queue||--------------------------

const TrainingBonusApprovalSchema = new mongoose.Schema(
  {
    username: { type: String, required: true },
    transactionId: { type: String, required: true },
    transactionAmount: { type: Number, required: true },
    gateway: { type: String, required: true },
    imagePath: { type: String, required: true },
    status: { type: String, default: 'pending' }
  },
  {
    timestamps: true // Automatically adds createdAt and updatedAt timestamps
  }
);

const TrainingBonusApproval = mongoose.model('TrainingBonusApproval', TrainingBonusApprovalSchema);

// Define approved schema
const TrainingBonusApprovedSchema = new mongoose.Schema(
  {
    username: { type: String, required: true },
    transactionId: { type: String, required: true },
    transactionAmount: { type: Number, required: true },
    gateway: { type: String, required: true },
    addedPoints: { type: Number, required: true },
    imagePath: { type: String, required: true },
    status: { type: String, default: 'approved' }
  },
  {
    timestamps: true // Automatically adds createdAt and updatedAt timestamps
  }
);

const TrainingBonusApproved = mongoose.model('TrainingBonusApproved', TrainingBonusApprovedSchema);

// Define rejected schema
const TrainingBonusRejectedSchema = new mongoose.Schema(
  {
    username: { type: String, required: true },
    transactionId: { type: String, required: true },
    transactionAmount: { type: Number, required: true },
    gateway: { type: String, required: true },
    imagePath: { type: String, required: true },
    feedback: { type: String, required: true },
    status: { type: String, default: 'rejected' }
  },
  {
    timestamps: true // Automatically adds createdAt and updatedAt timestamps
  }
);

const TrainingBonusRejected = mongoose.model('TrainingBonusRejected', TrainingBonusRejectedSchema);

// Multer storage configuration
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, '../uploads/training-bonus'); // Uploads folder where files will be stored
  },
  filename: function (req, file, cb) {
    const ext = path.extname(file.originalname);
    cb(null, file.fieldname + '-' + Date.now() + ext);
  }
});

// Multer file filter
const fileFilter = (req, file, cb) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(new Error('Only image files are allowed!'), false);
  }
};

// Multer upload instance
const upload = multer({ storage: storage, fileFilter: fileFilter });

app.use(express.json());

// -----------||POST route for uploading training bonus data||---------------

app.post('/api/training-bonus/upload', upload.single('image'), async (req, res) => {
  try {
    const { username, transactionId, transactionAmount, gateway } = req.body;

    // Construct the file path for the uploaded image
    const imagePath = req.file.path;

    // Create new TrainingBonusApproval document
    const newApproval = new TrainingBonusApproval({
      username,
      transactionId,
      transactionAmount: Number(transactionAmount),
      gateway,
      imagePath: imagePath
    });

    // Save the new document to MongoDB
    await newApproval.save();

    res.status(201).json({ message: 'Training bonus approval data uploaded successfully.' });
  } catch (err) {
    console.error('Error uploading training bonus data:', err);
    res.status(500).json({ error: 'Internal server error.' });
  }
});

// Fetch training bonuses for the user
app.get('/api/training-bonus/:username', async (req, res) => {
  try {
    const bonuses = await TrainingBonusApproval.find({ username: req.params.username }).sort({ createdAt: -1 });
    res.json(bonuses);
  } catch (error) {
    console.error('Error fetching training bonuses:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});

// Fetch approved training bonuses for the user
app.get('/api/approvals/approve/:username', async (req, res) => {
  try {
    const approvedBonuses = await TrainingBonusApproved.find({ username: req.params.username }).sort({ createdAt: -1 });
    res.json(approvedBonuses);
  } catch (error) {
    console.error('Error fetching approved training bonuses:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});

// Fetch rejected training bonuses for the user
app.get('/api/approvals/reject/:username', async (req, res) => {
  try {
    const rejectedBonuses = await TrainingBonusRejected.find({ username: req.params.username }).sort({ createdAt: -1 });
    res.json(rejectedBonuses);
  } catch (error) {
    console.error('Error fetching rejected training bonuses:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});

//       ]------------------------||Investment Plans Model||----------------------------[

const planSchema = new mongoose.Schema({
  name: { type: String, required: true },
  price: { type: Number, required: true },
  advancePoints: { type: Number, required: true },
  DirectPoint: { type: Number, required: true },
  IndirectPoint: { type: Number, required: true },
  parent: { type: Number, required: true },
  grandParent: { type: Number, required: true }
});
const Plan = mongoose.model('Plan', planSchema);

//      ]---------------------GET all Plans Documents-----------------------[

app.get('/api/plans', async (req, res) => {
  try {
    const plans = await Plan.find();
    res.json(plans);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});
// ]-------------------||Get Profile Data by username from User Model||-------------------------[

app.get('/api/users/:username', async (req, res) => {
  try {
    const user = await User.findOne({ username: req.params.username });
    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }
    res.json({
      fullName: user.fullName,
      rank: user.rank,
      plan: user.plan,
      refPer: user.refPer,
      phone: user.phoneNumber,
      refParentPer: user.refParentPer
    });
  } catch (error) {
    res.status(500).json({ message: 'Server error' });
  }
});

const referralPaymentSchema = new mongoose.Schema({
  username: { type: String, required: true },
  transactionId: { type: String, required: true },
  transactionAmount: { type: Number, required: true },
  gateway: { type: String, required: true },
  planName: { type: String, required: true },
  planPRICE: { type: Number, required: true },
  advancePoints: { type: Number, required: true },
  DirectPoint: { type: Number, required: true },
  IndirectPoint: { type: Number, required: true },
  refPer: { type: Number, required: true },
  refParentPer: { type: Number, required: true },
  referrerPin: { type: String, required: true, unique: true },
  imagePath: { type: String, required: true },
  status: { type: String, default: 'pending' }
}, { timestamps: true });

const ReferralPaymentVerification = mongoose.model('ReferralPaymentVerification', referralPaymentSchema);
const ReferralApproveds = mongoose.model('ReferralApproveds', referralPaymentSchema);
const referralRejectedSchema = new mongoose.Schema({
  username: { type: String, required: true },
  transactionId: { type: String, required: true },
  transactionAmount: { type: Number, required: true },
  gateway: { type: String, required: true },
  imagePath: { type: String, required: true },
  reason: { type: String, required: true },
  status: { type: String, default: 'rejected' }
}, { timestamps: true });

const ReferralRejected = mongoose.model('ReferralRejected', referralRejectedSchema);

// Multer storage configuration
const referralStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, '../uploads/referral-plan-payment');
  },
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    cb(null, file.fieldname + '-' + Date.now() + ext);
  }
});

const uploadReferral = multer({ storage: referralStorage });

//----------------------|| POST route to handle payment verification upload||-------------------
const generateUniquePin = async () => {
  let pin;
  let isUnique = false;

  while (!isUnique) {
    pin = Math.random().toString(36).substring(2, 12); // Generate a random 10-character string
    const existingPin = await ReferralPaymentVerification.findOne({ referrerPin: pin });
    if (!existingPin) {
      isUnique = true;
    }
  }

  return pin;
};

app.post('/api/referral-payment/upload', uploadReferral.single('image'), async (req, res) => {
  try {
    // Generate a unique referrer pin
    const referrerPin = await generateUniquePin();

    // Create a new ReferralPaymentVerification instance
    const newPayment = new ReferralPaymentVerification({
      username: req.body.username,
      transactionId: req.body.transactionId,
      transactionAmount: req.body.transactionAmount,
      gateway: req.body.gateway,
      planName: req.body.planName,
      planPRICE: req.body.planPRICE,
      advancePoints: req.body.advancePoints,
      DirectPoint: req.body.DirectPoint,
      IndirectPoint: req.body.IndirectPoint,
      refPer: req.body.parent,
      refParentPer: req.body.grandParent,
      referrerPin: referrerPin, // Add referrer pin
      imagePath: req.file.path // Store path to uploaded image
    });

    // Save to MongoDB
    await newPayment.save();

    // Respond with success message
    res.status(201).json({ message: 'Payment verification details saved successfully.' });
  } catch (error) {
    console.error('Error saving payment verification:', error);
    res.status(500).json({ error: 'Failed to save payment verification details.' });
  }
});

// Endpoint to fetch referral payment verifications by username
app.get('/api/referral-payment/:username', async (req, res) => {
  const { username } = req.params;

  try {
    const referralPayments = await ReferralPaymentVerification.find({ username: username });
    res.json(referralPayments);
  } catch (error) {
    console.error('Error fetching referral payment verifications:', error);
    res.status(500).json({ error: 'Failed to fetch referral payment verifications.' });
  }
});

// Fetch approvals by username
app.get('/api/approvals/referral/approve/:username', async (req, res) => {
  const { username } = req.params;
  try {
    const approvals = await ReferralApproveds.find({ username });
    res.json(approvals);
  } catch (error) {
    console.error('Error fetching approvals:', error);
    res.status(500).send('Server error');
  }
});

// Fetch rejected approvals by username
app.get('/api/approvals/referral/reject/:username', async (req, res) => {
  const { username } = req.params;
  try {
    const rejectedApprovals = await ReferralRejected.find({ username });
    res.json(rejectedApprovals);
  } catch (error) {
    console.error('Error fetching rejected approvals:', error);
    res.status(500).send('Server error');
  }
});


// User Accounts Model
const userAccountsSchema = new mongoose.Schema(
  {
    username: { type: String, required: true },
    gateway: { type: String, required: true },
    accountNumber: { type: String, required: true },
    accountTitle: { type: String, required: true }
  },
  { timestamps: true }
);

const UserAccounts = mongoose.model('UserAccounts', userAccountsSchema);

// ------------------||POST route to add user payment account||------------------------

app.post('/api/user-accounts/add', async (req, res) => {
  const { username, gateway, accountNumber, accountTitle } = req.body;

  try {
    // Create a new UserAccounts instance
    const newUserAccount = new UserAccounts({
      username,
      gateway,
      accountNumber,
      accountTitle
    });

    // Save to MongoDB
    await newUserAccount.save();

    // Respond with success message
    res.status(201).json({ message: 'Account added successfully.' });
  } catch (error) {
    console.error('Error adding account:', error);
    res.status(500).json({ error: 'Failed to add account.' });
  }
});
// ------------------||PUT route to edit user payment account||------------------------
app.put('/api/user-accounts/edit/:id', async (req, res) => {
  const { id } = req.params; // Account ID
  const { gateway, accountNumber, accountTitle } = req.body;

  try {
    // Find and update the account details by ID
    const updatedAccount = await UserAccounts.findByIdAndUpdate(
      id,
      { gateway, accountNumber, accountTitle },
      { new: true, runValidators: true } // Return the updated document and validate the input
    );

    if (!updatedAccount) {
      return res.status(404).json({ message: 'Account not found.' });
    }

    res.status(200).json({ message: 'Account updated successfully.', account: updatedAccount });
  } catch (error) {
    console.error('Error updating account:', error);
    res.status(500).json({ error: 'Failed to update account.' });
  }
});
// ------------------||DELETE route to remove user payment account||------------------------
app.delete('/api/user-accounts/delete/:id', async (req, res) => {
  const { id } = req.params; // Account ID

  try {
    // Find and delete the account by ID
    const deletedAccount = await UserAccounts.findByIdAndDelete(id);

    if (!deletedAccount) {
      return res.status(404).json({ message: 'Account not found.' });
    }

    res.status(200).json({ message: 'Account deleted successfully.', account: deletedAccount });
  } catch (error) {
    console.error('Error deleting account:', error);
    res.status(500).json({ error: 'Failed to delete account.' });
  }
});

// ]-------------------||GET route to fetch user accounts by username||----------------------[

app.get('/api/user-accounts/:username', async (req, res) => {
  const { username } = req.params;

  try {
    const accounts = await UserAccounts.find({ username });
    res.status(200).json(accounts);
  } catch (error) {
    console.error('Error fetching accounts:', error);
    res.status(500).json({ error: 'Failed to fetch accounts.' });
  }
});

const userPendingSchema = new mongoose.Schema(
  {
    planName: { type: String, required: true },
    planPRICE: { type: Number, required: true },
    advancePoints: { type: Number, required: true },
    DirectPoint: { type: Number, required: true },
    IndirectPoint: { type: Number, required: true },
    refPer: { type: Number, required: true },
    refParentPer: { type: Number, required: true },
    referrerPin: { type: String, required: true, unique: true },
    referrerId: { type: mongoose.Schema.Types.ObjectId, required: true, ref: 'User' }
  },
  { timestamps: true }
);

const UserPending = mongoose.model('UserPending', userPendingSchema);

// ]-----------------------||Endpoint for user signup||------------------------[

app.post('/api/signup', async (req, res) => {
  const { fullName, username, email, password, phoneNumber, referrerPin } = req.body;

  try {
    // Check if referrerPin exists in UserPending
    const userPending = await UserPending.findOne({ referrerPin });
    if (!userPending) {
      return res.status(400).json({ success: false, message: 'Invalid referrer PIN' });
    }

    // Check if the email or username already exists in the User model
    const existingUser = await User.findOne({ $or: [{ email }, { username }] });
    if (existingUser) {
      return res.status(400).json({ success: false, message: 'Email or username already taken' });
    }

    // Create a new user based on the form data and UserPending document
    const newUser = new User({
      fullName,
      username,
      email,
      password,
      phoneNumber,
      plan: userPending.planName,
      rank: '',
      refPer: userPending.refPer,
      refParentPer: userPending.refParentPer,
      parent: userPending.referrerId,
      advancePoints: userPending.advancePoints,
      // Initialize other fields as needed
      balance: 0,
      totalPoints: 0,
      directPoints: 0,
      indirectPoints: 0,
      trainingBonusBalance: 0
    });

    // Save the new user to the database
    await newUser.save();
    await UserPending.findByIdAndRemove(userPending.id);

    // Respond with success
    res.status(201).json({ success: true, message: 'User registered successfully!' });
  } catch (error) {
    console.error('Error during registration:', error);
    res.status(500).json({ success: false, message: 'Server error. Please try again later.' });
  }
});

// ]----------------------------||Get Total Balance||-----------------------------[

app.get('/api/user/:username', async (req, res) => {
  try {
    const username = req.params.username;
    const user = await User.findOne({ username }).exec();

    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    res.status(200).json({
      phone: user.phoneNumber,
      balance: user.balance,
      totalPoints: user.totalPoints,
      advancePoints: user.advancePoints,
      trainingBonusBalance: user.trainingBonusBalance
    });
  } catch (error) {
    res.status(500).json({ message: 'Server error', error });
  }
});
// Endpoint to get the count of direct referrals
app.get('/api/referrals', async (req, res) => {
  const { username } = req.query;

  try {
    // Find the main user by username
    const mainUser = await User.findOne({ username });

    if (!mainUser) {
      return res.status(404).json({ message: 'User not found' });
    }

    // Count the number of users who have the main user's _id as their parent
    const directReferralsCount = await User.countDocuments({ parent: mainUser._id });
    const directReferral = await User.findOne({ parent: mainUser._id });
    const IndirectReferralsCount = await User.countDocuments({ parent: directReferral._id });

    return res.json({ DirectCount: directReferralsCount, IndirectCount: IndirectReferralsCount });
  } catch (error) {
    console.error('Error counting direct referrals:', error);
    return res.status(500).json({ message: 'Internal server error' });
  }
});

// ----------------------||Api to handle Password change||----------------------
app.put('/api/change-password', async (req, res) => {
  const { username, currentPassword, newPassword } = req.body;

  try {
    const user = await User.findOne({ username });

    if (!user || user.password !== currentPassword) {
      return res.status(401).json({ message: 'Invalid current password' });
    }

    user.password = newPassword;
    await user.save();

    res.json({ message: 'Password changed successfully' });
  } catch (err) {
    res.status(500).json({ message: 'Internal server error' });
  }
});


// ----------------------||Notification||----------------------



const notificationSchema = new mongoose.Schema({
  userName: { type: String, required: true },
  message: { type: String, required: true },
  type: { type: String, enum: ['alert', 'message'], default: 'message' },
  timestamp: { type: Date, default: Date.now },
  status: { type: String, enum: ['read', 'unread'], default: 'unread' }
});

const Notification = mongoose.model('Notification', notificationSchema);


// API Endpoints
app.get('/api/notifications/:username', async (req, res) => {
  try {
    const notifications = await Notification.find({ userName: req.params.username });
    if (!notifications || notifications.length === 0) {
      return res.status(404).json({ message: 'No notifications found for this user' });
    }
    res.json(notifications);
  } catch (error) {
    res.status(500).json({ message: 'Error fetching notifications', error: error.message });
  }
});

// Create a new notification
app.post('/api/notifications', async (req, res) => {
  const { userName, message, type } = req.body;

  try {
    const newNotification = new Notification({ userName, message, type });
    await newNotification.save();
    res.status(201).json(newNotification);
  } catch (error) {
    res.status(500).json({ message: 'Error creating notification', error: error.message });
  }
});

// Update a notification's status
app.put('/api/notifications/:id', async (req, res) => {
  const { status } = req.body;

  try {
    const updatedNotification = await Notification.findByIdAndUpdate(req.params.id, { status }, { new: true });
    if (!updatedNotification) {
      return res.status(404).json({ message: 'Notification not found' });
    }
    res.json(updatedNotification);
  } catch (error) {
    res.status(500).json({ message: 'Error updating notification status', error: error.message });
  }
});



//------------------------||WithdrawalRequest Schema (Client Side)||--------------------------

const withdrawalRequestSchema = new mongoose.Schema(
  {
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },
    amount: {
      type: Number,
      required: true
    },
    status: {
      type: String,
      enum: ['pending', 'approved', 'rejected'],
      default: 'pending'
    },
    accountNumber: {
      type: String,
      required: true
    },
    accountTitle: {
      type: String,
      required: true
    },
    gateway: {
      type: String,
      required: true
    },
    remarks: {
      type: String,
      default: null // This field is for admin remarks, especially in case of rejection
    }
  },
  { timestamps: true }
);

const WithdrawalRequest = mongoose.model('WithdrawalRequest', withdrawalRequestSchema);

// Submit a withdrawal request (User Side - No remarks, status is 'pending')
// Submit a withdrawal request (User Side - Balance validation included)
app.post('/api/withdraw-balance', async (req, res) => {
  const { username, withdrawAmount, gateway, accountNumber, accountTitle } = req.body;

  try {
    // Find the user by username
    const user = await User.findOne({ username });
    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    // Check if the user's balance is sufficient
    if (user.balance < withdrawAmount) {
      return res.status(400).json({ message: 'Insufficient balance for withdrawal.' });
    }

    // Create and save new withdrawal request (Balance not deducted here, status is pending)
    const newWithdrawalRequest = new WithdrawalRequest({
      userId: user._id,
      amount: withdrawAmount,
      accountNumber,
      accountTitle,
      gateway,
      status: 'pending', // Status is pending by default
      createdAt: new Date(), // Optional: track request creation time
    });
    await newWithdrawalRequest.save();

    res.status(200).json({ 
      message: 'Withdrawal request submitted successfully.', 
      requestId: newWithdrawalRequest._id 
    });
  } catch (error) {
    console.error('Error processing withdrawal request:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});


// Fetch withdrawal requests (Transactions) for the user
app.get('/api/withdrawals/:username', async (req, res) => {
  try {
    const user = await User.findOne({ username: req.params.username });
    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    // Fetch all withdrawal requests (acts as transactions)
    const withdrawalRequests = await WithdrawalRequest.find({ userId: user._id }).sort({ createdAt: -1 });

    res.json(withdrawalRequests); // Return the request with status and remarks (if any)
  } catch (error) {
    console.error('Error fetching withdrawal history:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});


app.get('/api/users/product-profit-history/:username', async (req, res) => {
  const { username } = req.params;

  try {
    const user = await User.findOne({ username });
    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    res.json(user.productProfitHistory);
  } catch (error) {
    console.error('Error fetching product profit history:', error);
    res.status(500).json({ message: 'Failed to fetch product profit history' });
  }
});



// Get Parent User Name
app.get('/api/user/:userId/parent', async (req, res) => {
  try {
    // Find the user based on the provided username
    const user = await User.findOne({ username: req.params.userId });

    // Check if the user exists
    if (!user) {
      return res.status(404).send('User not found');
    }

    // Check if the user has a parent ID
    if (!user.parent) {
      return res.status(404).send('No parent found for this user');
    }

    // Fetch the parent user details using the parent ID
    const parent = await User.findById(user.parent).select('fullName username');

    // Check if the parent exists
    if (!parent) {
      return res.status(404).send('Parent user not found');
    }

    // Return the parent's details
    res.send({ parent });

  } catch (err) {
    res.status(500).send(err);
  }
});

// Multer storage configuration for profile pictures
const profilePictureStorage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, path.join(__dirname, '../uploads/profile-pictures')); // Ensure correct path
  },
  filename: function (req, file, cb) {
    const ext = path.extname(file.originalname);
    cb(null, 'profile-' + Date.now() + ext); // Use a unique name for the profile picture
  }
});

// Create the multer instance
const profileUpload = multer({ storage: profilePictureStorage });


// Your route for uploading profile pictures
app.post('/api/user/:username/profile-picture', profileUpload.single('profilePicture'), (req, res) => {
  const filePath = `uploads/profile-pictures/${req.file.filename}`; // Save as a relative path

  // Save the file path in the user document in the database
  User.findOneAndUpdate({ username: req.params.username }, { profilePicture: filePath }, { new: true })
    .then(user => {
      if (!user) {
        return res.status(404).json({ message: 'User not found' });
      }
      res.json({ user });
    })
    .catch(err => {
      console.error('Error saving profile picture:', err);
      res.status(500).json({ message: 'Error saving profile picture' });
    });
});


// Route to update user information including the profile picture
app.put('/api/user/:username', profileUpload.single('profilePicture'), async (req, res) => {
  const { username } = req.params;
  const { fullName, email, phoneNumber } = req.body;

  try {
    const updates = { fullName, email, phoneNumber };

    if (req.file) {
      updates.profilePicture = `uploads/profile-pictures/${req.file.filename}`; // Save as relative path
    }

    const user = await User.findOneAndUpdate({ username }, updates, { new: true });

    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    res.json({ message: 'User updated successfully', user });
  } catch (error) {
    if (error instanceof multer.MulterError) {
      console.error('Multer Error:', error);
      return res.status(400).json({ message: error.message });
    }
    console.error('Error updating user:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});



//------------------------|whatsappChat page backend||--------------------------

// Define Mongoose Schema for WhatsApp Contacts
const whatsappContactSchema = new mongoose.Schema({
  whatsappNumber: { type: String, required: true, unique: true },
  fullName: { type: String, required: true },
  email: { type: String, required: true },
  phoneNumber: { type: String, required: true },
}, { timestamps: true });

const WhatsappContact = mongoose.model('WhatsappContact', whatsappContactSchema);


// Get all WhatsApp contacts
app.get('/api/admin/whatsapp/contacts', async (req, res) => {
  try {
    const contacts = await WhatsappContact.find();
    res.json({ contacts });
  } catch (err) {
    console.error('Error fetching WhatsApp contacts:', err);
    res.status(500).json({ message: 'Server error' });
  }
});
